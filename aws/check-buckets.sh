#!/usr/bin/env bash

# set -e: Прерывает выполнение скрипта при любой ошибке, кроме случаев, когда ошибка обрабатывается (например, в if)
set -e

# --- ИСПРАВЛЕНИЕ: Используем переменную для имени бакета ---
BUCKET_NAME="events-bot-uploads"
echo "--- Проверка состояния S3 бакета '$BUCKET_NAME' ---"

# 1. Главная проверка: существует ли бакет?
# Это самая важная проверка. Если бакета нет, остальные проверки бессмысленны.
echo "1/2: Проверка существования бакета..."
if ! awslocal s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
  echo "❌ ОШИБКА: Бакет '$BUCKET_NAME' не существует."
  echo "Пожалуйста, убедитесь, что скрипт 'aws/buckets.sh' был выполнен успешно."
  exit 1 # --- ИСПРАВЛЕНИЕ: Выход с кодом ошибки ---
fi
echo "✅ Бакет '$BUCKET_NAME' существует."

# 2. Если бакет существует, проверяем конфигурацию CORS
# Это гарантирует, что к бакету можно будет обращаться извне (если это необходимо).
echo "2/2: Проверка конфигурации CORS..."
if ! awslocal s3api get-bucket-cors --bucket "$BUCKET_NAME" 2>/dev/null; then
  echo "❌ ОШИБКА: Конфигурация CORS для бакета '$BUCKET_NAME' не найдена или неверна."
  echo "Пожалуйста, убедитесь, что скрипт 'aws/buckets.sh' применил настройки CORS."
  exit 1 # --- ИСПРАВЛЕНИЕ: Выход с кодом ошибки ---
fi
echo "✅ Конфигурация CORS для бакета '$BUCKET_NAME' установлена."

echo -e "\n--- ✅ Проверка S3 успешно пройдена ---"
exit 0